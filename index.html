<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ðŸŒŒ Space Factory</title>

<!-- ======================
      GLOBAL STYLES
====================== -->
<style>
:root{
    --bg:#071028;
    --panel:#0f1b3a;
    --accent:#6fb3ff;
    --muted: #9fb5d9;
    --glass: rgba(255,255,255,0.04);
}

html,body{
    height:100%;
    margin:0;
    background:linear-gradient(180deg,var(--bg),#031026);
    color:#eaf4ff;
    font-family:Inter,system-ui,monospace;
}

/* ---------------------
   Galaxy Header
--------------------- */
.galaxy-header {
    padding: 28px 0 10px 0;
    text-align: center;
}

.galaxy-title {
    font-size: clamp(28px, 4vw, 48px);
    margin: 0;
    font-weight: 800;
    background: linear-gradient(90deg, #6fb3ff, #9f70ff, #ff70d7, #6fb3ff);
    background-size: 300% 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: galaxyFlow 8s ease infinite;
    text-shadow: 0 0 18px rgba(125,150,255,0.35), 0 0 35px rgba(150,90,255,0.25);
}

.galaxy-subtitle {
    margin-top: 6px;
    font-size: 15px;
    color: #bcd7ff;
    letter-spacing: 0.4px;
}

@keyframes galaxyFlow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* ---------------------
   Layout Panels
--------------------- */
#wrap {
    display:flex;
    gap:16px;
    padding:16px;
    justify-content:center;
    flex-wrap:wrap;
}

.panel{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
    border-radius:12px;
    padding:12px;
    width:340px;
    box-shadow:0 6px 20px rgba(3,6,20,0.6);
}

.wide{
    width:720px;
}

.resource{
    display:flex;
    justify-content:space-between;
    padding:6px 0;
    border-bottom:1px dashed rgba(255,255,255,0.03);
}

.muted{
    color:var(--muted);
    font-size:13px;
}

.stat{ font-weight:700; }

button{
    background:linear-gradient(180deg,var(--accent),#4e8fe3);
    border:none;
    color:#02112a;
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    font-weight:700;
}
button:hover{
    filter:brightness(1.1);
}
button:disabled{
    opacity:0.45;
    cursor:not-allowed;
}

.bigbtn{
    padding:12px 14px;
    font-size:15px;
}

.grid{
    display:grid;
    grid-template-columns:repeat(1,1fr);
    gap:8px;
}

.top-row{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
}

.save-indicator{
    font-size:12px;
    color:var(--muted);
}

.planetBtn{
    background:transparent;
    border:1px solid rgba(255,255,255,0.06);
    color:var(--muted);
    padding:8px;
    border-radius:8px;
    cursor:pointer;
}
</style>
</head>
<body>

<!-- ======================
      HEADER
====================== -->
<header class="galaxy-header">
    <h1 class="galaxy-title">ðŸŒŒ Space Factory</h1>
    <div class="galaxy-subtitle">Build factories, expand your colony, and explore the stars.</div>
</header>

<!-- ======================
      PLANET SELECTOR
====================== -->
<div id="planetSelector" class="panel" style="margin:auto;margin-top:20px;width:380px;">
    <h3>Select Starting Planet</h3>
    <button class="planetBtn" onclick="startPlanet('Lunar')">ðŸŒ• Lunar â€” abundant ore, low metal</button><br><br>
    <button class="planetBtn" onclick="startPlanet('Mars')">ðŸ”´ Mars â€” balanced</button><br><br>
    <button class="planetBtn" onclick="startPlanet('Europa')">ðŸ§Š Europa â€” energy rich</button>
    <div class="muted" style="margin-top:10px;">You can unlock more planets after building a Spaceport.</div>
</div>

<!-- ======================
      GAME HUD
====================== -->
<div id="mainHUD" style="display:none;">
    <div class="top-row" style="margin-bottom:10px">
        <div class="muted">Planet: <span id="planetName">â€”</span></div>
        <div class="muted">Space: <span id="spaceState">Locked</span></div>
        <div class="save-indicator" id="saveStatus">Not saved</div>
    </div>
    <div style="text-align:center" class="muted">
        <span id="capLabels"></span>
    </div>
</div>

<!-- ======================
      MAIN GAME UI
====================== -->
<div id="wrap" style="display:none;">

    <!-- Left Panel: Planet Overview -->
    <div class="panel">
        <h3>Manual Actions</h3>
        <button class="bigbtn" onclick="manualMine()">Mine Ore</button>
        <button class="bigbtn" onclick="manualEnergy()">Generate Energy</button>
        <button class="bigbtn" onclick="asteroidMine()" id="asteroidBtn" disabled>Asteroid Mine</button>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.05);margin:10px 0;">
        
        <h3>Storage</h3>
        <button onclick="expandStorage()" class="bigbtn">Upgrade Storage</button>
    </div>

    <!-- Center Panel: Resources & Factories -->
    <div class="panel wide">
        <h3>Resources</h3>
        <div id="resourcesList"></div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

        <h3>Factories</h3>
        <div id="buildGrid"></div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

        <label><input type="checkbox" id="autoProduce" checked> <span class="muted">Auto-produce resources</span></label>
    </div>

    <!-- Right Panel: Production Chains & Unlocks -->
    <div class="panel">
        <h3>Production Chains</h3>
        <div id="chains"></div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

        <h3>Crafting</h3>
        <div id="craftingArea" style="display:grid;gap:8px;"></div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

        <h3>Structures</h3>
        <div class="muted">Shipyard: <span id="shipyardCount">0</span></div>
        <div class="muted">AI Lab: <span id="aiLabCount">0</span></div>
        <div class="muted">Spaceport: <span id="spaceportCount">0</span></div>
        <br>

        <button onclick="attemptUnlockSpace()" id="unlockSpaceBtn">
            Unlock Space (500 ore / 200 metal / 150 energy)
        </button>
        <div class="muted" id="unlockText">Space locked â€” gather resources.</div>
        <br><br>

        <div class="muted">Planets owned: <span id="planetList">None</span></div>
    </div>

</div>

<!-- ======================
      JAVASCRIPT
====================== -->
<script>
/* ============================
      GAME STATE
============================ */
const initialState = {
    planet: null,
    spaceUnlocked: false,

    resources: {
        ore: 0,
        metal: 0,
        energy: 0,
        crystal: 0,
        alloy: 0,
        circuit: 0,
        fuelCell: 0,
        shipPart: 0,
        aiCore: 0,
    },

    storageCap: {
        ore: 1000, metal: 500, energy: 500,
        crystal: 200, alloy: 200, circuit: 100,
        fuelCell: 100, shipPart: 50, aiCore:20
    },

    factories: {
        oreFactory: 0,
        energyGen: 0,
        smelter: 0,
        crystalExtractor: 0,
        circuitFoundry: 0,
        alloyForge: 0,
        fuelProcessor: 0,
    },

    structures:{
        shipyard:0,
        aiLab:0,
        spaceport:0
    },

    upgrades:{ storageLevel:0 },
    planetsOwned: [],
    lastSaved:null,
    tickAccumulator:0
};

let state = load() || initialState;

/* ============================
      PLANETS
============================ */
const planets = {
    Lunar: { oreCap:500, metalCap:200, energyCap:150, startBonus:{ore:50} },
    Mars:  { oreCap:350, metalCap:350, energyCap:250, startBonus:{metal:30} },
    Europa:{ oreCap:200, metalCap:300, energyCap:500, startBonus:{energy:50} },

    // unlocked after space
    Ceres:{ asteroid:true, desc:"Asteroid mining zone" },
    Kepler:{ desc:"Exoplanet with rare crystals" }
};

/* ============================
      COSTS
============================ */
const buildCosts = {
    oreFactory:{ ore:20, energy:5 },
    energyGen:{ ore:10 },
    smelter:{ ore:50, energy:10 },
    crystalExtractor:{ ore:120, metal:40 },
    circuitFoundry:{ metal:200, crystal:50, energy:40 },
    alloyForge:{ metal:150, energy:60 },
    fuelProcessor:{ ore:100, energy:80 },

    Shipyard:{ alloy:500, circuit:200 },
    "AI Lab":{ metal:1000, crystal:500 },
    Spaceport:{ ore:100000, metal:20000, circuit:2500 }
};

/* ============================
      PRODUCTION CONFIG
============================ */
const factoryProduction = {
    oreFactory:{ produce:{ore:1}, perSec:1 },
    energyGen:{ produce:{energy:1}, perSec:1 },
    smelter:{ consume:{ore:3}, produce:{metal:1}, perSec:1 },
    crystalExtractor:{ produce:{crystal:0.25}, perSec:1 },
    circuitFoundry:{ consume:{metal:1, crystal:1}, produce:{circuit:1}, perSec:1 },
    alloyForge:{ consume:{metal:4}, produce:{alloy:1}, perSec:1 },
    fuelProcessor:{ consume:{ore:3, energy:2}, produce:{fuelCell:1}, perSec:1 },

    Shipyard:{ consume:{alloy:10, circuit:4}, produce:{shipPart:1}, perSec:8 },
    "AI Lab":{ consume:{circuit:20, crystal:10}, produce:{aiCore:1}, perSec:40 }
};

/* ============================
      HELPERS
============================ */
function clampToStorage(resource, amount){
    return Math.min(amount, state.storageCap[resource] || amount);
}

function canAfford(cost){
    for(const k in cost){
        if((state.resources[k]||0) < cost[k]) return false;
    }
    return true;
}

function payCost(cost){
    for(const k in cost){
        state.resources[k] -= cost[k];
    }
}

function addResource(key, amt){
    state.resources[key] = (state.resources[key]||0) + amt;

    // enforce planet caps early game
    if(!state.spaceUnlocked && state.planet){
        const p = planets[state.planet];
        if(key==="ore" && state.resources.ore > p.oreCap) state.resources.ore = p.oreCap;
        if(key==="metal" && state.resources.metal > p.metalCap) state.resources.metal = p.metalCap;
        if(key==="energy" && state.resources.energy > p.energyCap) state.resources.energy = p.energyCap;
    }

    // enforce storage caps
    state.resources[key] = clampToStorage(key, state.resources[key]);
}

/* ============================
      UI RENDERING
============================ */
function renderResources(){
    const el = document.getElementById("resourcesList");
    el.innerHTML = "";
    for(const r in state.resources){
        const div = document.createElement("div");
        div.className = "resource";
        const val = Math.floor(state.resources[r]*100)/100;
        const cap = state.storageCap[r];
        div.innerHTML =
            `<div class="muted">${r}</div>
             <div><span class="stat">${val}</span> <span class="muted">/ ${cap}</span></div>`;
        el.appendChild(div);
    }
}

function renderBuildGrid(){
    const grid = document.getElementById("buildGrid");
    grid.innerHTML = "";

    const items = [
        {key:'oreFactory', name:'Ore Factory', desc:'Produces ore', cost:buildCosts.oreFactory},
        {key:'energyGen', name:'Energy Generator', desc:'Creates energy', cost:buildCosts.energyGen},
        {key:'smelter', name:'Smelter', desc:'Ore â†’ Metal', cost:buildCosts.smelter},
        {key:'crystalExtractor', name:'Crystal Extractor', desc:'Generates crystals', cost:buildCosts.crystalExtractor},
        {key:'circuitFoundry', name:'Circuit Foundry', desc:'Metal+Crystal â†’ Circuits', cost:buildCosts.circuitFoundry},
        {key:'alloyForge', name:'Alloy Forge', desc:'Metal â†’ Alloy', cost:buildCosts.alloyForge},
        {key:'fuelProcessor', name:'Fuel Processor', desc:'Ore+Energy â†’ Fuel Cells', cost:buildCosts.fuelProcessor}
    ];

    items.forEach(it=>{
        const div = document.createElement("div");
        div.style.padding = "6px 0";
        div.innerHTML =
            `<div style="font-weight:700">${it.name} <span class="muted">x${state.factories[it.key]}</span></div>
             <div class="muted">${it.desc}</div>
             <div class="muted" style="font-size:13px">${renderCost(it.cost)}</div>
             <button onclick="buildFactory('${it.key}')">Build</button>`;
        grid.appendChild(div);
    });
}

function renderChains(){
    const el = document.getElementById("chains");
    el.innerHTML = "";

    const chains = [
        {name:'Ore â†’ Metal (Smelter)', count:state.factories.smelter},
        {name:'Metal â†’ Alloy (Alloy Forge)', count:state.factories.alloyForge},
        {name:'Metal+Crystal â†’ Circuit (Circuit Foundry)', count:state.factories.circuitFoundry},
        {name:'Ore+Energy â†’ Fuel Cell (Fuel Processor)', count:state.factories.fuelProcessor},
    ];

    for(const c of chains){
        const div = document.createElement("div");
        div.className = "muted";
        div.style.marginBottom = "8px";
        div.innerHTML = `<b>${c.name}</b><br>Built: ${c.count}`;
        el.appendChild(div);
    }
}

function renderCrafting(){
    const el = document.getElementById("craftingArea");
    el.innerHTML = "";

    const craftables = [
        {name:'Circuit (1 metal + 1 crystal)', cost:{metal:1, crystal:1}, res:'circuit'},
        {name:'Alloy (4 metal)', cost:{metal:4}, res:'alloy'}
    ];

    craftables.forEach(c=>{
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.justifyContent = "space-between";
        row.innerHTML =
            `<div class="muted">${c.name}</div>
             <button onclick="craft('${c.res}', ${JSON.stringify(c.cost)})">Craft</button>`;
        el.appendChild(row);
    });
}

function renderStructures(){
    document.getElementById("shipyardCount").innerText = state.structures.shipyard;
    document.getElementById("aiLabCount").innerText = state.structures.aiLab;
    document.getElementById("spaceportCount").innerText = state.structures.spaceport;
}

function updateHUD(){
    document.getElementById("planetName").innerText = state.planet || "â€”";
    document.getElementById("spaceState").innerText = state.spaceUnlocked ? "Unlocked" : "Locked";

    if(state.planet){
        const caps = planets[state.planet];
        document.getElementById("capLabels").innerText = 
            state.spaceUnlocked ? 
            "No caps â€” space unlocked" :
            `Ore cap: ${caps.oreCap}, Metal cap: ${caps.metalCap}, Energy cap: ${caps.energyCap}`;
    }

    document.getElementById("saveStatus").innerText = 
        state.lastSaved ? `Saved ${new Date(state.lastSaved).toLocaleTimeString()}` : "Not saved";

    document.getElementById("unlockText").innerText =
        state.spaceUnlocked ? "Space unlocked â€” new planets available!" : "Space locked â€” gather resources.";

    document.getElementById("planetList").innerText =
        state.planetsOwned.length ? state.planetsOwned.join(", ") : "Only starting planet";

    document.getElementById("asteroidBtn").disabled = !state.spaceUnlocked;
    document.getElementById("unlockSpaceBtn").disabled = state.spaceUnlocked;
}

function renderAll(){
    renderResources();
    renderBuildGrid();
    renderChains();
    renderCrafting();
    renderStructures();
    updateHUD();
}

/* ============================
      ACTIONS
============================ */
function startPlanet(name){
    state = JSON.parse(JSON.stringify(initialState));
    state.planet = name;

    // starting bonus
    const bonus = planets[name].startBonus || {};
    for(const k in bonus) state.resources[k] = bonus[k];

    state.planetsOwned = [name];

    document.getElementById("planetSelector").style.display = "none";
    document.getElementById("mainHUD").style.display = "block";
    document.getElementById("wrap").style.display = "flex";

    renderAll();
    save();
}

function manualMine(){ addResource('ore', 1); renderAll(); save(); }
function manualEnergy(){ addResource('energy', 1); renderAll(); save(); }

function asteroidMine(){
    if(!state.spaceUnlocked) return;
    const oreGain = Math.floor(Math.random()*200)+50;
    const metalGain = Math.floor(Math.random()*60)+10;
    addResource('ore', oreGain);
    addResource('metal', metalGain);
    renderAll(); save();
}

function expandStorage(){
    const lvl = state.upgrades.storageLevel;
    const cost = { ore:200*(lvl+1), metal:100*(lvl+1), energy:50*(lvl+1) };

    if(!canAfford(cost)){ alert("Not enough resources."); return; }

    payCost(cost);
    state.upgrades.storageLevel++;

    for(const r in state.storageCap){
        state.storageCap[r] = Math.floor(state.storageCap[r] * 1.5);
    }

    renderAll();
    save();
}

function buildFactory(key){
    const cost = buildCosts[key];
    if(!canAfford(cost)){ alert("Cannot afford."); return; }
    payCost(cost);
    state.factories[key]++;
    renderAll(); save();
}

function build(name){
    const cost = buildCosts[name];
    if(!canAfford(cost)){ alert("Cannot afford."); return; }
    payCost(cost);

    if(name==="Shipyard"){
        state.structures.shipyard++;
    }
    else if(name==="AI Lab"){
        state.structures.aiLab++;
    }
    else if(name==="Spaceport"){
        state.structures.spaceport++;
        state.spaceUnlocked = true;
        if(!state.planetsOwned.includes("Ceres")) state.planetsOwned.push("Ceres","Kepler");
    }

    renderAll();
    save();
}

function craft(resourceKey, cost){
    if(!canAfford(cost)){ alert("Not enough resources."); return; }
    payCost(cost);
    addResource(resourceKey, 1);
    renderAll(); save();
}

function attemptUnlockSpace(){
    if(state.spaceUnlocked){ alert("Already unlocked."); return; }
    const cost = {ore:500, metal:200, energy:150};
    if(!canAfford(cost)){ alert("Cannot afford."); return; }
    payCost(cost);

    state.spaceUnlocked = true;
    state.planetsOwned.push("Ceres","Kepler");

    renderAll(); save();
}

/* ============================
      PRODUCTION LOOP
============================ */
function runFactoryProduction(key, dt){
    const cfg = factoryProduction[key];
    const count = state.factories[key];
    if(count<=0) return;

    for(let i=0;i<count;i++){
        // consumption check
        let canRun = true;
        if(cfg.consume){
            for(const r in cfg.consume){
                const need = cfg.consume[r] * dt;
                if((state.resources[r]||0) < need){
                    canRun = false;
                    break;
                }
            }
        }
        if(!canRun) continue;

        // apply consumption
        if(cfg.consume){
            for(const r in cfg.consume){
                const amt = cfg.consume[r] * dt;
                state.resources[r] -= amt;
            }
        }

        // production
        if(cfg.produce){
            for(const r in cfg.produce){
                const amt = cfg.produce[r] * dt;
                addResource(r, amt);
            }
        }
    }
}

let lastTime = Date.now();
function gameLoop(){
    const now = Date.now();
    let dt = (now - lastTime) / 1000;
    lastTime = now;
    if(dt>0.25) dt = 0.25;

    if(document.getElementById("autoProduce").checked){
        runFactoryProduction("oreFactory", dt);
        runFactoryProduction("energyGen", dt);
        runFactoryProduction("smelter", dt);
        runFactoryProduction("crystalExtractor", dt);
        runFactoryProduction("circuitFoundry", dt);
        runFactoryProduction("alloyForge", dt);
        runFactoryProduction("fuelProcessor", dt);

        // passive Europa bonus
        if(state.planet==="Europa"){
            addResource("crystal", 0.02 * dt);
        }
    }

    state.tickAccumulator += dt;
    if(state.tickAccumulator >= 0.4){
        renderAll();
        state.tickAccumulator = 0;
    }

    if(!state.lastSaved || Date.now()-state.lastSaved > 10000){
        save();
    }

    requestAnimationFrame(gameLoop);
}

/* ============================
      SAVE / LOAD
============================ */
function save(){
    state.lastSaved = Date.now();
    localStorage.setItem("spaceFactorySave", JSON.stringify(state));
}

function load(){
    try{
        const raw = localStorage.getItem("spaceFactorySave");
        return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
}

/* ============================
      INIT
============================ */
function init(){
    if(state.planet){
        document.getElementById("planetSelector").style.display = "none";
        document.getElementById("mainHUD").style.display = "block";
        document.getElementById("wrap").style.display = "flex";
    }

    renderAll();
    requestAnimationFrame(gameLoop);
}

init();

// Expose functions globally
window.startPlanet = startPlanet;
window.manualMine = manualMine;
window.manualEnergy = manualEnergy;
window.asteroidMine = asteroidMine;
window.expandStorage = expandStorage;
window.buildFactory = buildFactory;
window.build = build;
window.craft = craft;
window.attemptUnlockSpace = attemptUnlockSpace;

function renderCost(cost){
    return Object.entries(cost).map(([k,v])=>`${v} ${k}`).join(" / ");
}
</script>

</body>
</html>

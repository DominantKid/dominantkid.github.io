<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸŒŒ Space Factory</title>
<style>
:root {
    --bg: #071028;
    --panel: #0f1b3a;
    --accent: #6fb3ff;
    --muted: #9fb5d9;
}

body {
    margin: 0;
    font-family: monospace;
    background: linear-gradient(180deg,var(--bg),#031026);
    color: #eaf4ff;
}

header {
    text-align: center;
    padding: 20px 0 10px 0;
}

.galaxy-title {
    font-size: clamp(28px,4vw,48px);
    font-weight: 800;
    background: linear-gradient(90deg,#6fb3ff,#9f70ff,#ff70d7,#6fb3ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: galaxyFlow 8s ease infinite;
    text-shadow: 0 0 18px rgba(125,150,255,0.35), 0 0 35px rgba(150,90,255,0.25);
}

.galaxy-subtitle { margin-top: 6px; font-size: 15px; color: #bcd7ff; }

@keyframes galaxyFlow {
    0% {background-position:0% 50%;}
    50% {background-position:100% 50%;}
    100% {background-position:0% 50%;}
}

#wrap { display: flex; gap: 16px; padding: 16px; justify-content: center; flex-wrap: wrap; }

.panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
    border-radius:12px;
    padding:12px;
    width: 340px;
    box-shadow:0 6px 20px rgba(3,6,20,0.6);
}

.wide { width:720px; }

.resource { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,0.03); }
.muted { color: var(--muted); font-size:13px; }
.stat { font-weight:700; }

button {
    background:linear-gradient(180deg,var(--accent),#4e8fe3);
    border:none; color:#02112a; padding:8px 10px; border-radius:8px;
    cursor:pointer; font-weight:700;
}
button:hover { filter: brightness(1.1); }
button:disabled { opacity:0.45; cursor:not-allowed; }
.bigbtn { padding:12px 14px; font-size:15px; }

#resetPopup, #resetOverlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    display:none; justify-content:center; align-items:center;
}
#resetOverlay { background: rgba(0,0,0,0.6); z-index: 900; }
#resetPopup {
    background: #222; color:white; padding:20px; border-radius:8px;
    box-shadow:0 0 10px #ff4d4d; z-index:1000; text-align:center;
    min-width: 250px;
}
</style>
</head>
<body>

<header>
    <h1 class="galaxy-title">ðŸŒŒ Space Factory</h1>
    <div class="galaxy-subtitle">Build factories, expand your colony, and explore the stars.</div>
</header>

<!-- Planet Selector -->
<div id="planetSelector" class="panel" style="margin:auto;margin-top:20px;width:380px;">
    <h3>Select Starting Planet</h3>
    <button onclick="startPlanet('Lunar')">ðŸŒ• Lunar â€” abundant ore, low metal</button><br><br>
    <button onclick="startPlanet('Mars')">ðŸ”´ Mars â€” balanced</button><br><br>
    <button onclick="startPlanet('Europa')">ðŸ§Š Europa â€” energy rich</button>
</div>

<!-- Game HUD -->
<div id="mainHUD" style="display:none;">
    <div class="panel wide">
        <h3>Resources</h3>
        <div id="resourcesList"></div>

        <hr>

        <h3>Storage Upgrade</h3>
        <div id="storageUpgradeArea"></div>

        <hr>

        <h3>Manual Actions</h3>
        <button class="bigbtn" onclick="manualMine()">Mine Ore</button>
        <button class="bigbtn" onclick="manualEnergy()">Generate Energy</button>
        <button class="bigbtn" onclick="asteroidMine()" id="asteroidBtn" disabled>Asteroid Mine</button>

        <hr>

        <h3>Factories</h3>
        <div id="buildGrid"></div>

        <hr>

        <button onclick="openResetMenu()" style="background:#ff4d4d;">Reset Game</button>
    </div>
</div>

<div id="resetOverlay"></div>
<div id="resetPopup">
    <p>Are you sure you want to reset?</p>
    <button onclick="resetGame()" style="margin-right:10px;background:#ff4d4d;color:white;">Yes</button>
    <button onclick="closeResetMenu()">No</button>
</div>

<script>
/* ===============================
        GAME STATE
================================*/
const initialState = {
    planet: null,
    spaceUnlocked: false,
    resources: { ore:0, metal:0, energy:0, crystal:0, alloy:0, circuit:0 },
    storageCap: { ore:1000, metal:500, energy:500, crystal:200, alloy:200, circuit:100 },
    factories: { oreFactory:0, energyGen:0, smelter:0 },
    upgrades: { storageLevel:0 },
    planetsOwned: [],
    lastSaved: null,
    tickAccumulator:0
};
let state = load() || JSON.parse(JSON.stringify(initialState));

const planets = {
    Lunar: { oreCap:500, metalCap:200, energyCap:150, startBonus:{ore:50} },
    Mars:  { oreCap:350, metalCap:350, energyCap:250, startBonus:{metal:30} },
    Europa:{ oreCap:200, metalCap:300, energyCap:500, startBonus:{energy:50} }
};

const buildCosts = {
    oreFactory:{ ore:20, energy:5 },
    energyGen:{ ore:10 },
    smelter:{ ore:50, energy:10 }
};

const factoryProduction = {
    oreFactory:{ produce:{ore:1}, perSec:1 },
    energyGen:{ produce:{energy:1}, perSec:1 },
    smelter:{ consume:{ore:3}, produce:{metal:1}, perSec:1 }
};

/* ===============================
        HELPERS
================================*/
function clampToStorage(resource, amount) {
    return Math.min(amount, state.storageCap[resource] || amount);
}

function canAfford(cost){
    for(const k in cost) if((state.resources[k]||0) < cost[k]) return false;
    return true;
}

function payCost(cost){ for(const k in cost) state.resources[k] -= cost[k]; }
function addResource(key, amt){ 
    if(state.resources[key] !== undefined){
        state.resources[key] = clampToStorage(key, state.resources[key]+amt);
    }
}

/* ===============================
        UI RENDER
================================*/
function renderResources(){
    const el = document.getElementById('resourcesList'); el.innerHTML='';
    for(const r in state.resources){
        if(state.resources[r]>0 || r==='ore' || r==='energy'){ // only show obtainable/owned
            const div = document.createElement('div');
            div.className='resource';
            div.innerHTML=`<div class="muted">${r}</div><div><span class="stat">${Math.floor(state.resources[r])}</span> / ${state.storageCap[r]}</div>`;
            el.appendChild(div);
        }
    }
}

function renderFactories(){
    const grid = document.getElementById('buildGrid'); grid.innerHTML='';
    for(const f in buildCosts){
        const cost = buildCosts[f];
        if(canAfford(cost)){
            const btn = document.createElement('button');
            btn.textContent=`Build ${f} (${Object.entries(cost).map(([k,v])=>v+' '+k).join('/')})`;
            btn.onclick = ()=>{ buildFactory(f); };
            grid.appendChild(btn);
        }
    }
}

function renderStorageUpgrade(){
    const area = document.getElementById('storageUpgradeArea'); area.innerHTML='';
    const level = state.upgrades.storageLevel;
    const cost = { ore:200*(level+1), metal:100*(level+1), energy:50*(level+1) };
    if(canAfford(cost)){
        const btn = document.createElement('button');
        btn.textContent=`Upgrade Storage (Level ${level+1}): ${Object.entries(cost).map(([k,v])=>v+' '+k).join('/')}`;
        btn.className='bigbtn';
        btn.onclick=()=>upgradeStorage();
        area.appendChild(btn);
    } else {
        area.textContent='Storage upgrade not affordable.';
    }
}

/* ===============================
        ACTIONS
================================*/
function startPlanet(name){
    state = JSON.parse(JSON.stringify(initialState));
    state.planet = name;
    const bonus = planets[name].startBonus||{};
    for(const k in bonus) state.resources[k]=bonus[k];
    state.planetsOwned=[name];
    document.getElementById('planetSelector').style.display='none';
    document.getElementById('mainHUD').style.display='block';
    renderAll();
    save();
}

function manualMine(){ addResource('ore',1); renderAll(); save(); }
function manualEnergy(){ addResource('energy',1); renderAll(); save(); }

function asteroidMine(){
    if(!state.spaceUnlocked) return;
    addResource('ore',Math.floor(Math.random()*200)+50);
    addResource('metal',Math.floor(Math.random()*50)+10);
    renderAll(); save();
}

function buildFactory(key){
    const cost = buildCosts[key];
    if(!canAfford(cost)){ alert("Cannot afford."); return; }
    payCost(cost);
    state.factories[key]++;
    renderAll(); save();
}

function upgradeStorage(){
    const lvl = state.upgrades.storageLevel;
    const cost = { ore:200*(lvl+1), metal:100*(lvl+1), energy:50*(lvl+1) };
    if(!canAfford(cost)){ alert("Cannot afford."); return; }
    payCost(cost); state.upgrades.storageLevel++;
    for(const r in state.storageCap) state.storageCap[r]=Math.floor(state.storageCap[r]*1.5);
    renderAll(); save();
}

/* ===============================
        RESET
================================*/
function openResetMenu(){ document.getElementById('resetPopup').style.display='flex'; document.getElementById('resetOverlay').style.display='flex'; }
function closeResetMenu(){ document.getElementById('resetPopup').style.display='none'; document.getElementById('resetOverlay').style.display='none'; }
function resetGame(){ closeResetMenu(); state = JSON.parse(JSON.stringify(initialState)); save(); location.reload(); }

/* ===============================
        PRODUCTION LOOP
================================*/
function runProduction(dt){
    for(const key in factoryProduction){
        const cfg = factoryProduction[key];
        const count = state.factories[key];
        if(count<=0) continue;
        let canRun=true;
        if(cfg.consume) for(const r in cfg.consume) if((state.resources[r]||0)<cfg.consume[r]*dt) canRun=false;
        if(!canRun) continue;
        if(cfg.consume) for(const r in cfg.consume) state.resources[r]-=cfg.consume[r]*dt;
        if(cfg.produce) for(const r in cfg.produce) addResource(r,cfg.produce[r]*dt);
    }
}

let lastTime = Date.now();
function gameLoop(){
    const now = Date.now();
    let dt=(now-lastTime)/1000; lastTime=now;
    if(dt>0.25) dt=0.25;
    runProduction(dt);
    state.tickAccumulator+=dt;
    if(state.tickAccumulator>0.4){ renderAll(); state.tickAccumulator=0; }
    if(!state.lastSaved || Date.now()-state.lastSaved>10000) save();
    requestAnimationFrame(gameLoop);
}

/* ===============================
        SAVE / LOAD
================================*/
function save(){ state.lastSaved=Date.now(); localStorage.setItem('spaceFactorySave',JSON.stringify(state)); }
function load(){ try{ const raw=localStorage.getItem('spaceFactorySave'); return raw?JSON.parse(raw):null; } catch{return null;} }

/* ===============================
        RENDER ALL
================================*/
function renderAll(){ renderResources(); renderFactories(); renderStorageUpgrade(); document.getElementById('asteroidBtn').disabled=!state.spaceUnlocked; }

/* ===============================
        INIT
================================*/
if(state.planet){ document.getElementById('planetSelector').style.display='none'; document.getElementById('mainHUD').style.display='block'; }
renderAll(); gameLoop();
</script>
</body>
</html>
